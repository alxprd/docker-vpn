#!/bin/sh

echo_template() {
	echo "Help: start-server -h"
	echo "Use:  start-server [-(m)anagement <remote-ip:port>]"
}

# Default param values:
management=''

while getopts 'hm:' optp
do
	case $optp in
		h) echo_template; exit 0 ;;
		m) management=$OPTARG ;;
	esac
done

#iptables -F && iptables -X
#ip6tables -F && ip6tables -X
#iptables-restore < /root/files/rules.v4
#ip6tables-restore < /root/files/rules.v6

iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o eth0 -j MASQUERADE

touch /etc/hosts.openvpn-clients
chmod a+w /etc/hosts.openvpn-clients
dnsmasq
# -d, --no-daemon: Do not go into the background at startup but otherwise run as normal.
# -q, --log-queries: Log the results of DNS queries handled by dnsmasq.

if [ -f "/root/server.zip" ]; then
	mkdir -p /etc/openvpn/server
	unzip /root/server.zip -d /etc/openvpn/server
else
	echo "No file 'server.conf' found!"
	exit 0
fi

if [ ! -z "${management}" ]; then

	management_ip=$(echo ${management} | cut -d':' -f1)
	management_port=$(echo ${management} | cut -d':' -f2)

	if [ -z "${management_ip}" ]; then
		echo "Asign a valid management ip!"
		echo_template
		exit 0
	fi

	if [ -z "${management_port}" ]; then
		echo "Asign a valid management port!"
		echo_template
		exit 0
	fi

	echo "Management enabled in '${management}'"
	#sed -i -e "s/;management <ip> <port>/management ${management_ip} ${management_port}/g" /etc/openvpn/server/server.conf


	# Munin:

	#sed -i -e "s/allow \^::1\$/allow \^::1\$\nallow \^${management_ip}\$/g" /etc/munin/munin-node.conf
	#sed -i -e "s/allow \^::1\$/allow \^::1\$\nallow \^172.17.0.2\$/g" /etc/munin/munin-node.conf

	sed -i -e "s/port 4949/port ${management_port}/g" /etc/munin/munin-node.conf
	echo "IPPP: ${management_ip}"

	#management_ip="172.17.0.2"
	#fixed_ip=$(sed 's|\.|\\\.|g' <<< $management_ip)
	fixed_ip=${management_ip//./\\.}
	echo "allow ^${fixed_ip}\$" >> /etc/munin/munin-node.conf

	#munin-node-configure --shell --families=contrib,auto | sh -x

	#servie munin-node restart
	#rc-service munin-node restart
	munin-node
fi

openvpn /etc/openvpn/server/server.conf
